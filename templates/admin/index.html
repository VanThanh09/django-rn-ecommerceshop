{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    .container {
        min-height: 78vh;
        display: flex;
        flex-direction: column;
    }
    .header-content {
        display: flex;
        gap: 25px;
        padding: 20px;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    .header-content a {
        color: white;
        text-decoration: none;
    }
    .header-content-card {
        flex: 1;
        min-width: 220px;
        min-height: 80px;
        background: #fff;
        border-radius: 10px;
        color: black;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        border: 2px solid white;
    }
    .header-content-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        cursor: pointer;
    }
    .main-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin: 0px 20px;
    }
    .sup-content {
        display: flex;
        flex: 1;
        gap: 20px;
        flex-wrap: wrap;
    }
    .chart {
        flex: 1;
        border-radius: 2px;
        padding: 10px;
        min-width: 400px;
        background: #ffffff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    .chart a {
        margin-top: 10px;
        padding: 8px 20px;
        border: none;
        background-color: #4CAF50;
        color: white;
        cursor: pointer;
        border-radius: 4px;
        text-decoration: none;
        display: inline-block;
    }
    .chart-title {
        font-family: 'Nunito', sans-serif;
    }

    .chart canvas {
        max-width: 100% !important;
        display: block;
    }

    #storeProductsChart {
        margin-right: auto;
        padding-left: 50px;
        width: 450px !important;
    }
    .custom-below-sidebar {
        padding: 10px;
        background: #fff3cd;
        border-top: 1px solid #ccc;
        margin: 10px;
    }
    .header-content-card .icon {
        font-size: 32px;
    }
    .info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
    }
    .info .title {
        font-size: 15px;
        opacity: 0.8;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0px;
    }
    .info .value {
        font-size: 15px;
        font-weight: 500;
        font-family: 'Roboto Mono', 'Fira Code', 'SF Mono', monospace;
        margin: 0px;
    }
    .user-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .store-card {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    .order-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .revenue-card {
        background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
    }
</style>
{% endblock %}

{% block content_title %}
    <div style="display: flex; align-items: center; gap: 20px; padding: 5px 13px;">
        <div>
            <h1 style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 700; font-size: 20px; margin: 0;">
                Xin chào, {% firstof user.get_short_name user.get_username %}
            </h1>
            {% load tz %}
            <p>Lần đăng nhập trước: {% timezone "Asia/Ho_Chi_Minh" %}{{ user.last_login }}{% endtimezone %}</p>
        </div>
    </div>
{% endblock %}

{% block nav-sidebar %}
    {{ block.super }}
{% endblock %}

{% block content %}
<div class="container">
    <div class="header-content">
        <div class="header-content-card user-card">
            <a style="padding: 20px;" title="Tới trang người dùng">
                <div class="icon"><i class="fa-regular fa-circle-user" style="color: #3c50e1;"></i></div>
                <div class="info">
                    <p class="title">Tổng người dùng</p>
                    <p class="value">{{ total_users }}</p>
                </div>
                <div class="info">
                    <p class="title">Số cửa hàng</p>
                    <p class="value">{{ total_stores }}</p>
                </div>
            </a>
        </div>

        <div class="header-content-card store-card">
            <a style="padding: 20px;" title="Tới trang cửa hàng">
                <div class="icon">&#128722;</div>
                <div class="info">
                    <p class="title">Số sản phẩm</p>
                    <p class="value">{{ total_products }}</p>
                </div>
                <div class="info">
                    <p class="title">Đã bán</p>
                    <p class="value">{{ sold_products }}</p>
                </div>
                <div class="info">
                    <p class="title">Bán trong 30 ngày</p>
                    <p class="value">{{ sold_products_30_days }}</p>
                </div>
            </a>
        </div>


        <div class="header-content-card order-card" title="Tới trang đơn hàng">
            <a style="padding: 20px;">
                <div class="icon">&#128230;</div>
                <div class="info">
                    <p class="title">Tổng đơn hàng</p>
                    <p class="value">{{total_order}}</p>
                </div>
                <div class="info">
                    <p class="title">30 ngày gần đây</p>
                    <p class="value">{{total_order_30_days}}</p>
                </div>
            </a>
        </div>

        <div class="header-content-card revenue-card" title="Tới trang cửa hàng">
            <a style="padding: 20px;">
                <div class="info">
                    <div class="icon">&#128181;</div>
                    <p class="title">Doanh thu sàn</p>
                </div>
                <div class="info">
                    <p class="title">30 ngày gần đây</p>
                    <p class="value">{{ revenue_30_days }} ₫</p>
                </div>
                <div class="info">
                    <p class="title">1 năm gần đây</p>
                    <p class="value">{{ revenue_1_year }} ₫</p>
                </div>
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="main-content">

        <div class="sup-content">

            <div class="chart" style="flex: 4">
                <h3 style="font-family: Arial, sans-serif; color: #333; text-align: center; font-size: 20px;">
                    Doanh thu tổng
                </h3>

                <div style="display: flex; justify-content: flex-end; align-items: center; margin-left: auto; margin-right: 10px">
                    <select id="timeRange" style="width: 200px">
                        <option value="7">7 ngày</option>
                        <option value="30" selected>30 ngày</option>
                        <option value="365">1 năm</option>
                        <option value="9999">Toàn bộ</option>
                    </select>
                </div>

                <canvas id="revenueChart"></canvas>

                <script>
                    const ctxRevenue = document.getElementById('revenueChart').getContext('2d');

                    let chart = null;

                    function renderChart(labels, data) {
                        if (chart) chart.destroy(); // Xóa chart cũ nếu có

                        chart = new Chart(ctxRevenue, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Doanh thu (VND)',
                                    data: data,
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    fill: true,
                                    tension: 0.3
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        ticks: {
                                            callback: function(value) {
                                                return value.toLocaleString("vi-VN");
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString("vi-VN") + ' VND';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }

                    async function fetchRevenue(days) {
                        const res = await fetch(`/revenue/?days=${days}`);
                        const result = await res.json();

                        const labels = result.map(item => item.date);
                        const data = result.map(item => item.revenue);

                        renderChart(labels, data);
                    }

                    fetchRevenue(30);

                    document.getElementById("timeRange").addEventListener("change", (e) => {
                        fetchRevenue(e.target.value);
                    });

                </script>


            </div>

            <div class="main-content" style="flex: 1; margin: 0px">
                <div class="chart" style="display: flex; flex-direction: column; align-items: center; text-align: center; padding: 0px 0px 20px;">
                    <h2 style="margin: 10px">Cửa Hàng Có Doanh Thu Cao Nhất</h2>
                    {% for id, name, logo, revenue in top_store %}
                    <div class="info" style="width: 85%;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="{{ logo.url }}" alt="{{ name }} Logo" style="width: 40px; height: 30px; object-fit: contain; border-radius: 5px;">
                            <p class="title">{{ name }}</p>
                        </div>
                        <p class="">{{ revenue }} ₫</p>
                    </div>
                    {% endfor %}
                    <a href="/admin/eshopapis/store/" style="margin-top: auto;">
                        Xem thêm
                    </a>
                </div>

                <div class="chart" style="display: flex; flex-direction: column; align-items: center; text-align: center; padding: 0px 0px 20px;">
                    <h2 style="margin: 10px">Danh Mục Có Nhiều Sản Phẩm Nhất</h2>
                    {% for name, count in top_categories %}
                    <div class="info" style="width: 85%;">
                        <p class="title">{{ name }}</p>
                        <p class="">{{ count }} sản phẩm</p>
                    </div>
                    {% endfor %}
                    <a href="/admin/eshopapis/category/">
                        Xem thêm
                    </a>
                </div>

            </div>
        </div>

        <div class="sup-content">
            <div class="chart">
                <h3 class="chart-title" style="color: #333; text-align: center; font-size: 20px;">
                    Lượt đăng ký mới
                </h3>

                <canvas id="userChart"></canvas>

                <script>
                    const labels = {{ user_chart_labels|safe }};
                    const data = {{ user_chart_data|safe }};

                    const ctxUser = document.getElementById('userChart');
                    const maxValue = Math.max(...data);
                    const padding = 1;
                    const suggestedMax = maxValue + padding;

                    new Chart(ctxUser, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: "Lượt đăng ký mới",
                                data: data,
                                fill: true,
                                borderColor: '#ff6663',
                                backgroundColor: 'rgba(255, 241, 234, 0.5)',
                                tension: 0.3,
                                pointBackgroundColor: '#b53a38',
                                pointBorderColor: '#fff',
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: suggestedMax,
                                    ticks: {
                                        stepSize: 1,
                                    },
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false, // Ẩn label
                                }
                            }
                        }
                    });
                </script>
            </div>

            <div class="chart">
                <h3 class="chart-title" style="color: #333; text-align: center; font-size: 20px;">
                    Sản phẩm cửa hàng
                </h3>

                <canvas id="storeProductsChart"></canvas>

                <script>
                    const ctxStore = document.getElementById("storeProductsChart");

                    new Chart(ctxStore, {
                        type: 'doughnut',
                        data: {
                          labels: [
                            'Red',
                            'Blue',
                            'Yellow'
                          ],
                          datasets: [{
                            label: 'My First Dataset',
                            data: [300, 50, 100],
                            backgroundColor: [
                              'rgb(255, 99, 132)',
                              'rgb(54, 162, 235)',
                              'rgb(255, 205, 86)'
                            ],
                            hoverOffset: 4
                          }]
                        },
                        options: {
                            responsive: true,
                        }
                    });

                </script>
            </div>

        </div>
    </div>

</div>

{% endblock %}
